<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Kriptografi S-Box</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link rel="stylesheet" href="/static/style.css">

    <!-- Enable dark mode in tailwind config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header Section with controls -->
        <header class="text-center mb-12 flex flex-col sm:flex-row justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 dark:text-gray-200 mb-2">Analisis Kriptografi S-Box</h1>
                <p class="text-lg text-gray-600 dark:text-gray-300">Metrik dan analisis visual untuk kotak substitusi</p>
            </div>

            <!-- Dark Mode Toggle -->
            <div class="flex space-x-4 mt-4 sm:mt-0">
                <button id="themeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition-colors duration-200">
                    <svg id="themeIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Introduction Card -->
        <section class="mb-10">
            <details class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                <summary class="cursor-pointer px-6 py-4 bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 font-medium flex justify-between items-center">
                    <span>Apa itu S-Box? Pelajari Dasar-dasar Kriptografi</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </summary>
                <div class="p-6">
                    <p class="mb-4">S-Box (Substitution Box) adalah komponen fundamental dalam banyak algoritma kriptografi, termasuk AES (Advanced Encryption Standard). Ini pada dasarnya adalah tabel pencarian yang melakukan substitusi.</p>

                    <p class="mb-4">S-Box digunakan untuk memperkenalkan nonlinearitas dalam sistem kriptografi, membuatnya tahan terhadap kriptanalisis linier dan diferensial.</p>

                    <h3 class="font-semibold text-lg mb-2">Mengapa Mengukur Properti Kriptografi?</h3>
                    <ul class="list-disc pl-6 mb-4 space-y-2">
                        <li><strong>Nonlinearitas (NL)</strong>: Mengukur ketahanan terhadap kriptanalisis linier</li>
                        <li><strong>Kriteria Avalanche Ketat (SAC)</strong>: Memastikan perubahan kecil pada input mempengaruhi ~50% bit output</li>
                        <li><strong>Kriteria Kemandirian Bit (BIC)</strong>: Memeriksa apakah bit-bit output berperilaku secara independen</li>
                        <li><strong>Uniformitas Diferensial (DU)</strong>: Mengukur ketahanan terhadap serangan diferensial</li>
                        <li><strong>Probabilitas Pendekatan Linear (LAP)</strong>: Menilai bias linear dalam S-box</li>
                    </ul>

                    <p>Metrik-metrik ini membantu mengevaluasi seberapa aman sebuah S-box terhadap berbagai metode serangan.</p>
                </div>
            </details>
        </section>

        <!-- S-Box Selection Section -->
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-10">
            <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-6">Analisis S-Box Anda</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                <!-- Predefined S-box Selection -->
                <div>
                    <label for="sbox-select" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-3">Pilih S-Box Bawaan</label>
                    <div class="flex items-center space-x-4">
                        <select id="sbox-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                            <option value="">Pilih S-Box...</option>
                        </select>
                        <button id="load-sbox-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition duration-200 font-medium">
                            Muat
                        </button>
                    </div>
                </div>

                <!-- Custom S-box Input -->
                <div>
                    <label for="custom-sbox" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-3">Atau Masukkan S-Box Kustom</label>
                    <p class="text-gray-600 dark:text-gray-400 mb-3">Masukkan 256 bilangan bulat antara 0 dan 255, dipisahkan koma:</p>
                    <textarea
                        id="custom-sbox"
                        rows="4"
                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                        placeholder="contoh: 99,224,149,199,47,218,49,104,... (256 nilai)">
                    </textarea>
                </div>
            </div>

            <!-- Compute Button -->
            <div class="text-center mt-8">
                <button
                    id="compute-btn"
                    class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg text-lg font-medium transition duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    Hitung Metrik Kriptografi
                </button>
            </div>
        </section>

        <!-- Results Section -->
        <div id="results" class="space-y-10">
            <!-- Results will be loaded here -->
        </div>

        <!-- Metric Explanations Section -->
        <section class="mt-12">
            <details class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                <summary class="cursor-pointer px-6 py-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-200 font-medium flex justify-between items-center">
                    <span>Bagaimana Metrik-Metrik Ini Bekerja</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </summary>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Nonlinearitas (NL)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Mengukur seberapa jauh S-Box dari fungsi linear manapun. Nilai yang lebih tinggi menunjukkan ketahanan yang lebih kuat terhadap kriptanalisis linier. Untuk S-Box 8x8, nilai maksimum teoritis adalah 120.</p>

                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Kriteria Avalanche Ketat (SAC)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Mengukur probabilitas bahwa pembalikan satu bit input mengubah setiap bit output. Nilai ideal adalah 0.5, artinya bit output berubah secara independen dengan probabilitas 50%.</p>

                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Kriteria Kemandirian Bit (BIC)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Memeriksa apakah bit-bit output berperilaku secara independen satu sama lain. Nilai tinggi menunjukkan properti independensi yang baik.</p>

                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Uniformitas Diferensial (DU)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Mengukur ketahanan terhadap kriptanalisis diferensial. Nilai yang lebih rendah menunjukkan keamanan yang lebih baik. Nilai ideal adalah 2.</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Probabilitas Pendekatan Linear (LAP)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Menilai bias linear dalam S-box. Nilai yang lebih rendah menunjukkan ketahanan yang lebih baik terhadap serangan linier. Nilai ideal mendekati 0.</p>

                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Tabel Distribusi Diferensial (DAP)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Menampilkan probabilitas maksimum dalam tabel distribusi diferensial. Nilai yang lebih rendah menunjukkan ketahanan yang lebih baik terhadap serangan diferensial.</p>

                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Indikator Absolut (AD)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Berhubungan dengan nonlinearitas S-Box. Nilai-nilai yang lebih tinggi biasanya menunjukkan properti kriptografi yang lebih kuat.</p>

                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Tingkat Transparansi (TO)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Mengukur ketahanan terhadap serangan sisi saluran (side-channel). Nilai-nilai yang lebih tinggi menunjukkan ketahanan yang lebih baik terhadap analisis korelasi kekuatan orde pertama.</p>

                            <h3 class="font-semibold text-lg mb-2 text-blue-600 dark:text-blue-400">Imunitas Korelasi (CI)</h3>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Mengukur ketahanan terhadap serangan korelasi. Nilai-nilai yang lebih tinggi menunjukkan kekuatan kriptografi yang lebih baik.</p>
                        </div>
                    </div>
                </div>
            </details>
        </section>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50">
        <div class="h-10 w-10 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
        <p id="loadingMessage" class="mt-4 text-gray-700 text-lg font-medium"></p>
    </div>

    <script>
        // Load available S-boxes on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/sboxes')
                .then(response => response.json())
                .then(sboxes => {
                    const selectElement = document.getElementById('sbox-select');
                    sboxes.forEach(sbox => {
                        const option = document.createElement('option');
                        option.value = sbox.id;
                        option.textContent = `${sbox.name} (${sbox.source})`;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading S-boxes:', error);
                });

            // Set up the compute button to send the current S-box
            document.getElementById('compute-btn').addEventListener('click', function() {
                // Get the selected S-box or custom input
                const customInput = document.getElementById('custom-sbox').value.trim();

                if (!customInput) {
                    alert('Please enter an S-box in the custom input field.');
                    return;
                }

                try {
                    // Parse the custom input
                    let sboxToUse = customInput.split(',').map(item => parseInt(item.trim()));

                    if (sboxToUse.length !== 256) {
                        alert(`Invalid S-box: Expected 256 values, got ${sboxToUse.length}`);
                        return;
                    }

                    // Validate that all values are between 0 and 255
                    for (let val of sboxToUse) {
                        if (isNaN(val) || val < 0 || val > 255) {
                            alert(`Invalid value: ${val}. All values must be integers between 0 and 255.`);
                            return;
                        }
                    }

                    // Show loading overlay
                    showLoadingOverlay();
                    startEducationalMessages();
                    showSkeleton();
                    disableComputeButton();

                    // Send the request to the API
                    fetch('/api/compute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({sbox: sboxToUse})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.ok) {
                            displayResults(data.metrics);
                        } else {
                            document.getElementById('results').innerHTML =
                                `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-center">Error: ${data.error}</div>`;
                        }

                        // Hide loading elements
                        hideLoadingOverlay();
                        hideSkeleton();
                        enableComputeButton();
                    })
                    .catch(error => {
                        document.getElementById('results').innerHTML =
                            `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-center">Error: ${error.message}</div>`;

                        // Hide loading elements
                        hideLoadingOverlay();
                        hideSkeleton();
                        enableComputeButton();
                    });

                } catch (e) {
                    document.getElementById('results').innerHTML =
                        `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-center">Error: ${e.message}</div>`;

                    // Hide loading elements
                    hideLoadingOverlay();
                    hideSkeleton();
                    enableComputeButton();
                }
            });

            // Update the load-sbox-btn to populate the textarea with selected S-box
            document.getElementById('load-sbox-btn').addEventListener('click', function() {
                const selectedSboxId = document.getElementById('sbox-select').value;
                if (!selectedSboxId) {
                    alert('Please select an S-box first.');
                    return;
                }

                // Fetch the specific S-box data
                fetch(`/api/sbox/${selectedSboxId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('custom-sbox').value = data.sbox.join(',');
                    })
                    .catch(error => {
                        console.error('Error loading S-box content:', error);
                        alert('Error loading S-box content. Please try again.');
                    });
            });
        });

        // Function to display results in a nice format
        function displayResults(metrics) {
            // Determine overall score based on metrics
            let overallScore = "Moderate";
            let scoreColor = "bg-yellow-100 dark:bg-yellow-900/30 border-yellow-400 dark:border-yellow-700";
            let scoreDescription = "S-Box ini memiliki properti kriptografi sedang.";
            let overallScoreText = "S-Box Sedang";

            // Evaluate based on key metrics
            if (metrics.NL >= 100 && metrics.SAC >= 0.48 && metrics.DU <= 8) {
                overallScore = "Strong";
                scoreColor = "bg-green-100 dark:bg-green-900/30 border-green-400 dark:border-green-700";
                scoreDescription = "S-Box ini menunjukkan properti kriptografi yang kuat dan ketahanan tinggi terhadap serangan yang diketahui.";
                overallScoreText = "S-Box Kuat";
            } else if (metrics.NL >= 80 && metrics.SAC >= 0.45 && metrics.DU <= 16) {
                overallScore = "Good";
                scoreColor = "bg-blue-100 dark:bg-blue-900/30 border-blue-400 dark:border-blue-700";
                scoreDescription = "S-Box ini memiliki properti kriptografi yang bagus dengan ketahanan yang layak terhadap sebagian besar serangan.";
                overallScoreText = "S-Box Baik";
            } else if (metrics.NL < 60 || metrics.DU > 32) {
                overallScore = "Weak";
                scoreColor = "bg-red-100 dark:bg-red-900/30 border-red-400 dark:border-red-700";
                scoreDescription = "S-Box ini memiliki properti kriptografi yang lemah dan ketahanan rendah terhadap serangan.";
                overallScoreText = "S-Box Lemah";
            }

            // Create the summary card
            const summaryCard = `
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Ringkasan Analisis</h2>
                <div class="p-6 \${scoreColor} border rounded-xl shadow-sm">
                    <div class="flex flex-col items-center justify-center text-center">
                        <h3 class="text-3xl font-bold mb-2">
                            \${overallScoreText}
                            <span class="inline-block ml-3 px-3 py-1 rounded-full text-sm font-semibold \${
                                overallScore === "Strong" ? "bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200" :
                                overallScore === "Good" ? "bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200" :
                                overallScore === "Moderate" ? "bg-yellow-200 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200" :
                                "bg-red-200 dark:bg-red-800 text-red-800 dark:text-red-200"
                            }">Skor Kualitas</span>
                        </h3>
                        <div class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">
                            Nonlinearitas: \${metrics.NL.toFixed(2)}, SAC: \${(metrics.SAC * 100).toFixed(2)}%, DU: \${metrics.DU}
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 max-w-2xl">\${scoreDescription}</p>
                    </div>
                </div>
            </section>`;

            // Generate metrics grid with skeleton and fade-in animation
            let metricsGrid = `
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-6">Metrik Terperinci</h2>
                <div id="metricsSkeleton" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6 animate-pulse">
                    <div class="h-32 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                    <div class="h-32 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                    <div class="h-32 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                    <div class="h-32 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                    <div class="h-32 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                    <div class="h-32 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 transition-opacity duration-500 opacity-0" id="metricsGrid">`;

            for (const [key, value] of Object.entries(metrics)) {
                let valueType = typeof value;
                let displayValue = value;

                // Format values appropriately
                if (valueType === 'number') {
                    if (key === 'SAC') {
                        displayValue = (value * 100).toFixed(2) + '%';
                    } else {
                        displayValue = value.toFixed(key === 'NL' ? 2 : 4);
                    }
                }

                // Get explanation for each metric from explanations
                let explanation = getMetricExplanation(key);

                metricsGrid += `
                    <div class="p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-200">
                        <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 mb-2">\${key}</h3>
                        <div class="text-3xl font-bold \${
                            key === 'NL' && value >= 100 ? 'text-green-600 dark:text-green-400' :
                            key === 'SAC' && value >= 0.48 ? 'text-green-600 dark:text-green-400' :
                            key === 'DU' && value <= 8 ? 'text-green-600 dark:text-green-400' :
                            key === 'DU' && value > 32 ? 'text-red-600 dark:text-red-400' :
                            'text-blue-600 dark:text-blue-400'
                        }">\${displayValue}</div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">\${explanation}</p>
                    </div>`;
            }

            metricsGrid += `</div></section>`;

            // Add visualization section
            const visualizationSection = `
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-6">Visualisasi</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="font-medium text-lg text-gray-800 dark:text-gray-200 mb-4 text-center">Ikhtisar Metrik Kriptografi</h3>
                        <canvas id="radarChart" width="400" height="400"></canvas>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="font-medium text-lg text-gray-800 dark:text-gray-200 mb-4 text-center">Distribusi SAC</h3>
                        <canvas id="sacChart" width="400" height="400"></canvas>
                    </div>
                </div>
            </section>`;

            // Combine all sections
            document.getElementById('results').innerHTML = summaryCard + metricsGrid + visualizationSection;

            // Fade in the metric cards after a short delay
            setTimeout(() => {
                document.getElementById('metricsGrid').classList.remove('opacity-0');
            }, 100);

            // Render charts if Chart.js and app.js are available
            if (typeof Chart !== 'undefined') {
                // Check if chart functions are available, otherwise wait for them to load
                if (typeof renderRadarChart !== 'undefined' && typeof renderSacChart !== 'undefined') {
                    // Normalize metrics for radar chart
                    const normalizedMetrics = normalizeMetricsForChart(metrics);
                    renderRadarChart(normalizedMetrics);

                    // Render SAC chart
                    renderSacChart(metrics.SAC);
                } else {
                    // If functions aren't available yet, set a short timeout to try again
                    setTimeout(function() {
                        if (typeof renderRadarChart !== 'undefined' && typeof renderSacChart !== 'undefined') {
                            const normalizedMetrics = normalizeMetricsForChart(metrics);
                            renderRadarChart(normalizedMetrics);
                            renderSacChart(metrics.SAC);
                        } else {
                            console.error('Chart functions are not available after timeout');
                        }
                    }, 100);
                }
            }
        }

        // Helper function to get metric explanations
        function getMetricExplanation(key) {
            const explanations = {
                'NL': 'Nonlinearitas mengukur ketahanan terhadap kriptanalisis linier. Semakin tinggi semakin baik.',
                'SAC': 'Kriteria Avalanche Ketat mengukur kemandirian bit. Nilai ideal adalah 0.5.',
                'BIC_NL': 'Kriteria Kemandirian Bit (Nonlinearitas) memeriksa kemandirian bit output.',
                'BIC_SAC': 'Kriteria Kemandirian Bit (SAC) mengevaluasi kemandirian efek avalanche.',
                'LAP': 'Probabilitas Pendekatan Linear menilai bias linear. Semakin rendah semakin baik.',
                'DAP': 'Probabilitas Pendekatan Diferensial mengukur bias diferensial. Semakin rendah semakin baik.',
                'DU': 'Uniformitas Diferensial menunjukkan ketahanan terhadap serangan diferensial. Semakin rendah semakin baik.',
                'AD': 'Indikator Absolut berhubungan dengan nonlinearitas. Nilai-nilai yang lebih tinggi menunjukkan properti yang lebih kuat.',
                'TO': 'Tingkat Transparansi mengukur ketahanan terhadap serangan sisi saluran. Semakin tinggi semakin baik.',
                'CI': 'Imunitas Korelasi mengukur ketahanan terhadap serangan korelasi. Semakin tinggi semakin baik.'
            };
            return explanations[key] || 'Pengukuran properti kriptografi.';
        }

        // Function to normalize metrics for radar chart
        function normalizeMetricsForChart(metrics) {
            // Define ideal values or max values for normalization
            const idealMaxValues = {
                'NL': 120,
                'SAC': 1,
                'BIC_NL': 120,
                'BIC_SAC': 0.5,
                'LAP': 0.25, // Max possible value
                'DAP': 0.25,
                'DU': 2, // Theoretical minimum
                'AD': 100, // Reference value
                'TO': 1, // Reference value
                'CI': 1 // Reference value
            };

            const normalized = {};
            for (const [key, value] of Object.entries(metrics)) {
                // For metrics where lower is better, invert the value
                if (['LAP', 'DAP', 'DU'].includes(key)) {
                    normalized[key] = 1 - Math.min(value / idealMaxValues[key], 1);
                } else {
                    // For metrics where higher is better
                    normalized[key] = Math.min(value / idealMaxValues[key], 1);
                }
            }
            return normalized;
        }

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeIcon').innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                `;
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeIcon').innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                `;
            }

            // Update charts theme if they exist
            if (typeof updateChartsTheme === 'function') {
                updateChartsTheme();
            }
        }

        // Set up theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;

            if (savedTheme === 'dark') {
                html.classList.add('dark');
                document.getElementById('themeIcon').innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                `;
            } else {
                html.classList.remove('dark');
                document.getElementById('themeIcon').innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                `;
            }

            // Set up theme toggle button
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        });

        // Educational Loading Functions
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showSkeleton() {
            const skeleton = document.getElementById('metricsSkeleton');
            if (skeleton) {
                skeleton.classList.remove('hidden');
            }
        }

        function hideSkeleton() {
            const skeleton = document.getElementById('metricsSkeleton');
            if (skeleton) {
                skeleton.classList.add('hidden');
            }
        }

        function disableComputeButton() {
            const button = document.getElementById('compute-btn');
            if (button) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function enableComputeButton() {
            const button = document.getElementById('compute-btn');
            if (button) {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Function to start educational messages (will be updated by app.js)
        function startEducationalMessages() {
            if (window.startMessageRotation) {
                window.startMessageRotation();
            }
        }
    </script>

    <!-- HTMX Event Handlers -->
    <script>
        document.body.addEventListener("htmx:beforeRequest", () => {
            showLoadingOverlay();
            startEducationalMessages();
            showSkeleton();
            disableComputeButton();
        });

        document.body.addEventListener("htmx:afterOnLoad", () => {
            hideLoadingOverlay();
            hideSkeleton();
            enableComputeButton();
            // Add fade-in effect to results
            const metricsGrid = document.getElementById('metricsGrid');
            if (metricsGrid) {
                setTimeout(() => {
                    metricsGrid.classList.remove('opacity-0');
                }, 100);
            }
        });
    </script>

    <!-- Load custom app.js for chart functions -->
    <script src="/static/app.js"></script>
</body>
</html>